<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte Intervenantes / Bénéficiaires</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    html,body,#map{height:100%;margin:0}
    .panel-left{
      position:absolute;top:10px;left:10px;z-index:1000;background:#fff;padding:10px;border-radius:8px;
      width:360px;max-width:90vw;box-shadow:0 2px 12px rgba(0,0,0,.15);font:14px system-ui
    }
    .panel-right{
      position:absolute;top:10px;right:10px;z-index:1000;background:#fff;padding:10px;border-radius:8px;
      width:360px;max-width:90vw;box-shadow:0 2px 12px rgba(0,0,0,.15);font:14px system-ui;display:none;
    }
    .btn{padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#f7f7f7;cursor:pointer}
    .btn + .btn { margin-left:6px }
    .row{margin:8px 0}
    .muted{color:#666}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    input, select { width:100%; box-sizing:border-box; padding:6px }
    fieldset { border:1px solid #eee; border-radius:8px; padding:8px }
    legend { font-weight:600; }
    .small { font-size:12px }
    .pill { display:inline-block; padding:2px 6px; border-radius:999px; background:#f0f0f0; margin:2px 4px 0 0 }
  </style>
</head>
<body>
<!-- Panneau GAUCHE -->
<div class="panel-left">
  <div class="row grid">
    <div>
      <strong>Filtres intervenantes</strong>
      <div id="filters" class="small"></div>
    </div>
    <div>
      <strong>Recherche d’adresse (BAN)</strong>
      <input id="banQuery" list="banList" placeholder="ex: 10 rue de Paris" />
      <datalist id="banList"></datalist>
      <button class="btn" id="btnBanGo">Aller</button>
    </div>
  </div>

  <div class="row">
    <button class="btn" id="btnSecteurs">Secteurs concaves</button>
    <button class="btn" id="btnIso10">Isochrone 10 min</button>
    <button class="btn" id="btnIso15">Isochrone 15 min</button>
  </div>

  <fieldset class="row">
    <legend>Connexion</legend>
    <div class="grid">
      <input type="email" id="email" placeholder="email" />
      <input type="password" id="password" placeholder="mot de passe" />
    </div>
    <div style="margin-top:6px">
      <button class="btn" id="btnLogin">Connexion</button>
      <button class="btn" id="btnLogout" style="display:none">Déconnexion</button>
      <span class="muted" id="authState" style="margin-left:6px">Utilisateur non connecté — connectez-vous</span>
    </div>
  </fieldset>

  <!-- Gestionnaire de couches sous la connexion -->
  <fieldset class="row" id="fs_layers">
    <legend>Gestionnaire de couches</legend>
    <label><input type="checkbox" id="lm_interv" checked> Intervenantes</label><br/>
    <label><input type="checkbox" id="lm_benef"  checked> Bénéficiaires</label><br/>
    <label><input type="checkbox" id="lm_hull"> Secteurs concaves</label><br/>
    <label><input type="checkbox" id="lm_iso"> Isochrones</label>
  </fieldset>
</div>

<!-- Panneau DROIT (éditeurs) — caché si non connecté -->
<div class="panel-right" id="panelRight">
  <!-- Intervenante -->
  <fieldset class="row" id="fs_create_interv">
    <legend>Créer / Éditer une intervenante</legend>
    <div class="grid">
      <input id="ci_id" placeholder="ID intervenante (ex: I01)" />
      <input id="ci_nom" placeholder="Nom" />
    </div>
    <div class="grid">
      <input id="ci_addr" list="banList" placeholder="Adresse (BAN)" />
      <input type="color" id="ci_color" value="#e91e63" />
    </div>
    <div class="small muted">Astuce : tape l’adresse puis clique “Géocoder”.</div>
    <div class="row">
      <button class="btn" id="ci_geocode">Géocoder adresse</button>
      <button class="btn" id="ci_save">Créer/Mettre à jour</button>
    </div>
    <div class="row">
      <strong>Lier un bénéficiaire</strong><br/>
      <select id="ci_benef_select"><option value="">— choisir bénéficiaire —</option></select>
      <button class="btn" id="ci_link">Lier (primaire)</button>
      <span class="small muted">ou créer un bénéficiaire :</span>
      <div class="grid" style="margin-top:6px">
        <input id="cb_id_inline" placeholder="ID bénéficiaire (ex: B01)" />
        <input id="cb_nom_inline" placeholder="Nom bénéficiaire" />
      </div>
      <input id="cb_addr_inline" list="banList" placeholder="Adresse bénéficiaire (BAN)" />
      <button class="btn" id="cb_create_and_link">Créer & Lier</button>
    </div>
    <div id="ci_status" class="small muted"></div>
  </fieldset>

  <!-- Bénéficiaire -->
  <fieldset class="row" id="fs_create_benef">
    <legend>Créer un bénéficiaire</legend>
    <div class="grid">
      <input id="cb_id" placeholder="ID bénéficiaire (ex: B02)" />
      <input id="cb_nom" placeholder="Nom" />
    </div>
    <input id="cb_addr" list="banList" placeholder="Adresse bénéficiaire (BAN)" />
    <select id="cb_interv_select"><option value="">— lier à intervenante —</option></select>
    <div class="row">
      <button class="btn" id="cb_geocode">Géocoder adresse</button>
      <button class="btn" id="cb_save">Créer & Lier</button>
    </div>
    <div id="cb_status" class="small muted"></div>
  </fieldset>

  <!-- Liens n-n -->
  <fieldset class="row" id="fs_links">
    <legend>Liens intervenantes ↔ bénéficiaires</legend>
    <select id="ln_benef"><option value="">— choisir bénéficiaire —</option></select>
    <div id="ln_interv_list" class="small" style="margin-top:6px"></div>
    <div class="row">
      <button class="btn" id="ln_save">Enregistrer les liens</button>
    </div>
    <div class="small muted">Cochez les intervenantes liées. La première cochée sera la “principale”.</div>
  </fieldset>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/*** ====== CONFIG ====== ***/
const SUPABASE_URL = 'https://fauiwnvaynlbfzqlilbi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhdWl3bnZheW5sYmZ6cWxpbGJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDM0NzksImV4cCI6MjA3MTExOTQ3OX0.wDBJt9fw44LFOZOoJrva8DXhR9ScsZpZMDdHiWfU1xE';
const MAP_CENTER = [48.8566, 2.3522], MAP_ZOOM = 12;
const ALLOW_EDIT = new Set(['mariemotta.geo@gmail.com','mariemotta@gmail.com']);

/*** ====== MAP (init en premier) ====== ***/
const map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:20 }).addTo(map);
const grpInterv = L.layerGroup().addTo(map);
const grpBenef  = L.layerGroup().addTo(map);
const hullLayer = L.layerGroup();
const isoLayer  = L.layerGroup();
const editGroup = L.featureGroup().addTo(map);

// Gestionnaire de couches (checkboxes)
function setLayerVisible(layer, checked){ if (checked) layer.addTo(map); else map.removeLayer(layer); }
document.getElementById('lm_interv').onchange = e => setLayerVisible(grpInterv, e.target.checked);
document.getElementById('lm_benef').onchange  = e => setLayerVisible(grpBenef,  e.target.checked);
document.getElementById('lm_hull').onchange   = e => setLayerVisible(hullLayer, e.target.checked);
document.getElementById('lm_iso').onchange    = e => setLayerVisible(isoLayer,  e.target.checked);

/*** ====== SUPABASE CLIENT ====== ***/
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let session = null;

/*** ====== HELPERS ====== ***/
function colorForFromProp(p){ return p?.color || colorFor(p?.id_intervenante); }
function colorFor(id){ let h=0; for (let i=0;i<String(id).length;i++) h=(h*31+String(id).charCodeAt(i))%360; return `hsl(${h},70%,45%)`; }
function canView(){ return !!session; }
function canEdit(){
  const email = session?.user?.email?.toLowerCase() || '';
  return !!session && ALLOW_EDIT.has(email);
}
function setAuthText(){
  document.getElementById('authState').textContent =
    session ? `Utilisateur connecté : ${session.user.email}` : 'Utilisateur non connecté — connectez-vous';
}
function showRightPanel(show){ document.getElementById('panelRight').style.display = show ? 'block' : 'none'; }
function clearLayers(){
  grpInterv.clearLayers(); grpBenef.clearLayers(); hullLayer.clearLayers(); isoLayer.clearLayers(); editGroup.clearLayers();
}

/*** ====== UI selon auth ====== ***/
function refreshAuthUI(){
  const show = !!session; // connecté = on montre le panneau
  const panel = document.getElementById('panelRight');
  if (panel) panel.style.display = show ? 'block' : 'none';

  // bouton de logout
  const btnLogout = document.getElementById('btnLogout');
  if (btnLogout) btnLogout.style.display = show ? 'inline-block' : 'none';

  // Leaflet.draw si éditeur autorisé
  if (window.drawCtrl) { map.removeControl(window.drawCtrl); window.drawCtrl = null; }
  if (session && ALLOW_EDIT.has((session.user?.email || '').toLowerCase())) {
    window.drawCtrl = new L.Control.Draw({ draw:false, edit:{ featureGroup: editGroup, remove:false } });
    map.addControl(window.drawCtrl);
    map.off(L.Draw.Event.EDITED);
    map.on(L.Draw.Event.EDITED, async (e)=>{
      for (const id in e.layers._layers){
        const layer = e.layers._layers[id];
        const f = layer.feature, ll = layer.getLatLng();
        const { error } = await supabase.from('api.beneficiaires_rw')
          .update({ lat: ll.lat, lon: ll.lng })
          .eq('id_beneficiaire', f.properties.id_beneficiaire);
        if (error) alert(error.message);
      }
      await loadData();
    });
  } else {
    map.off(L.Draw.Event.EDITED);
  }
}


/*** ====== BAN ====== ***/
async function geocodeBAN(q){
  if(!q) return [];
  const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&limit=5`);
  const j = await res.json();
  return (j.features||[]).map(f=>({ label:f.properties.label, lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0] }));
}
document.getElementById('btnBanGo').onclick = async ()=>{
  const q = document.getElementById('banQuery').value.trim();
  const items = await geocodeBAN(q);
  const dl = document.getElementById('banList'); dl.innerHTML='';
  items.forEach(r=>{ const opt = document.createElement('option'); opt.value = r.label; dl.appendChild(opt); });
  if (items[0]) map.setView([items[0].lat, items[0].lon], 16);
};

/*** ====== DATA ====== ***/
const filterSet = new Set();
let cacheInterv = [], cacheBenef = [];

async function loadData(){
  const resI = await supabase.from('api.vw_intervenantes_points').select('*');
  if (resI.error) { alert(resI.error.message); return; }
  const resB = await supabase.from('api.vw_beneficiaires_enriched').select('*');
  if (resB.error) { alert(resB.error.message); return; }
  cacheInterv = resI.data||[];
  cacheBenef  = resB.data||[];
  renderInterv(cacheInterv);
  renderBenef(cacheBenef);
  buildFilters(cacheInterv, cacheBenef);
  populateSelects();
  refreshAuthUI();
}

function renderInterv(rows){
  grpInterv.clearLayers();
  const feats = rows.filter(r=>r.lat && r.lon).map(r=>({
    type:'Feature', geometry:{type:'Point', coordinates:[r.lon, r.lat]}, properties:r
  }));
  L.geoJSON({type:'FeatureCollection', features:feats},{
    pointToLayer:(f, latlng)=>L.circleMarker(latlng,{radius:7,color:'#000',weight:1,fillColor:colorForFromProp(f.properties),fillOpacity:.9}),
    onEachFeature:(f,l)=>l.bindTooltip(`${f.properties.id_intervenante} — ${f.properties.nom||''}`)
  }).addTo(grpInterv);
}

function renderBenef(rows){
  grpBenef.clearLayers(); editGroup.clearLayers();
  const feats = rows.filter(r=>r.lat && r.lon).map(r=>({
    type:'Feature', geometry:{type:'Point', coordinates:[r.lon, r.lat]}, properties:r
  }));
  const colorByInterv = Object.fromEntries(cacheInterv.map(i=>[String(i.id_intervenante), i.color || colorFor(i.id_intervenante)]));
  L.geoJSON({type:'FeatureCollection', features:feats},{
    filter:(f)=> !filterSet.size || (f.properties.intervenantes||[]).some(x=>filterSet.has(String(x))),
    pointToLayer:(f, latlng)=>{
      const ints = f.properties.intervenantes||[];
      const primary = f.properties.primary_intervenante || ints[0] || null;
      const second  = ints.length>=2 ? ints[1] : null;
      const fillCol = primary ? (colorByInterv[primary] || colorFor(primary)) : '#666';
      const strokeCol = second ? (colorByInterv[second] || colorFor(second)) : '#000';
      return L.circleMarker(latlng, {radius:6, color: strokeCol, weight:2, fillColor: fillCol, fillOpacity:.85});
    },
    onEachFeature:(f, layer)=>{
      layer.on('click', ()=>{
        const p=f.properties, ints=(p.intervenantes||[]).join(', ');
        const disabled = canEdit() ? '' : 'disabled';
        const html = `
          <b>${p.nom||p.id_beneficiaire}</b><br>
          Adresse: <input id="f_addr" value="${p.adresse_beneficiaire||''}" style="width:100%"><br>
          Intervenantes (CSV): <input id="f_ints" value="${ints}" style="width:100%"><br>
          <button id="btnSave" ${disabled}>Enregistrer</button>
          <button id="btnPrim" ${disabled}>Définir principale</button>
        `;
        layer.bindPopup(html).openPopup();
        layer.once('popupopen', ()=>{
          const $ = id => document.getElementById(id);
          if (canEdit()){
            $('btnSave').onclick = async ()=>{
              const addr = $('f_addr').value.trim();
              const ids  = $('f_ints').value.split(',').map(s=>s.trim()).filter(Boolean);
              await supabase.from('api.lien_rw').delete().eq('id_beneficiaire', p.id_beneficiaire);
              if (ids.length){
                const rows = ids.map((id,i)=>({ id_beneficiaire:p.id_beneficiaire, id_intervenante:id, is_primary:i===0 }));
                const ins = await supabase.from('api.lien_rw').insert(rows);
                if (ins.error) { alert(ins.error.message); return; }
              }
              const up = await supabase.from('api.beneficiaires_rw').update({ adresse_beneficiaire: addr }).eq('id_beneficiaire', p.id_beneficiaire);
              if (up.error) alert(up.error.message);
              await loadData();
            };
            $('btnPrim').onclick = async ()=>{
              const ids = $('f_ints').value.split(',').map(s=>s.trim()).filter(Boolean);
              if (!ids.length) return;
              await supabase.from('api.lien_rw').update({ is_primary:false }).eq('id_beneficiaire', p.id_beneficiaire);
              const set = await supabase.from('api.lien_rw').update({ is_primary:true })
                .eq('id_beneficiaire', p.id_beneficiaire).eq('id_intervenante', ids[0]);
              if (set.error) alert(set.error.message);
              await loadData();
            };
          }
        });
      });
      editGroup.addLayer(layer);
    }
  }).addTo(grpBenef);
  refreshAuthUI();
}

function buildFilters(intervRows, benefRows){
  const ids = new Set();
  intervRows.forEach(r=>ids.add(String(r.id_intervenante)));
  (benefRows||[]).forEach(r=>(r.intervenantes||[]).forEach(x=>ids.add(String(x))));
  const box = document.getElementById('filters'); box.innerHTML='';
  Array.from(ids).sort().forEach(id=>{
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" value="${id}"> ${id}`;
    label.querySelector('input').onchange = e=>{
      if (e.target.checked) filterSet.add(id); else filterSet.delete(id);
      renderBenef(cacheBenef);
    };
    box.appendChild(label);
  });
}

function populateSelects(){
  const selBenef = document.getElementById('ci_benef_select'); selBenef.innerHTML='<option value="">— choisir bénéficiaire —</option>';
  cacheBenef.forEach(b => { const o = document.createElement('option'); o.value=b.id_beneficiaire; o.textContent=`${b.id_beneficiaire} — ${b.nom||''}`; selBenef.appendChild(o); });
  const selInterv = document.getElementById('cb_interv_select'); selInterv.innerHTML='<option value="">— lier à intervenante —</option>';
  cacheInterv.forEach(i => { const o = document.createElement('option'); o.value=i.id_intervenante; o.textContent=`${i.id_intervenante} — ${i.nom||''}`; selInterv.appendChild(o); });
  const lnB = document.getElementById('ln_benef'); lnB.innerHTML = '<option value="">— choisir bénéficiaire —</option>';
  cacheBenef.forEach(b=>{ const o = document.createElement('option'); o.value=b.id_beneficiaire; o.textContent=`${b.id_beneficiaire} — ${b.nom||''}`; lnB.appendChild(o); });
}

/*** ====== SECTEURS / ISO ====== ***/
document.getElementById('btnSecteurs').onclick = async ()=>{
  if (!canView()) return alert('Connectez-vous.');
  hullLayer.clearLayers();
  const q = await supabase.from('api.vw_secteurs_concaves_geojson').select('id_intervenante, geojson');
  if (q.error) { alert(q.error.message); return; }
  (q.data||[]).forEach(r => L.geoJSON(r.geojson, { style:{ color: colorFor(r.id_intervenante), weight:2, fillOpacity:.15 }}).addTo(hullLayer));
  if (!map.hasLayer(hullLayer)) { document.getElementById('lm_hull').checked = true; hullLayer.addTo(map); }
};
async function doIso(seconds){
  if (!canView()) return alert('Connectez-vous.');
  isoLayer.clearLayers();
  const ids = (Array.from(filterSet).length ? Array.from(filterSet) : cacheInterv.map(r=>r.id_intervenante));
  const { data, error } = await supabase.functions.invoke('isochrones', { body:{ ids, range:[seconds] }});
  if (error) { alert(error.message || 'Erreur isochrones'); return; }
  L.geoJSON(data, { style:{ color:'#000', weight:1, fillOpacity:.08 } }).addTo(isoLayer);
  if (!map.hasLayer(isoLayer)) { document.getElementById('lm_iso').checked = true; isoLayer.addTo(map); }
}
document.getElementById('btnIso10').onclick = ()=>doIso(600);
document.getElementById('btnIso15').onclick = ()=>doIso(900);

/*** ====== CRUD Intervenante ====== ***/
let ci_lat=null, ci_lon=null;
document.getElementById('ci_geocode').onclick = async ()=>{
  const addr = document.getElementById('ci_addr').value.trim();
  if (!addr) return;
  const hits = await geocodeBAN(addr);
  if (!hits.length) return alert('Adresse introuvable.');
  ci_lat = hits[0].lat; ci_lon = hits[0].lon;
  map.setView([ci_lat, ci_lon], 16);
};
document.getElementById('ci_save').onclick = async ()=>{
  if (!canEdit()) return alert('Non autorisé.');

  const id = document.getElementById('ci_id').value.trim();
  const nom = document.getElementById('ci_nom').value.trim();
  const addr = document.getElementById('ci_addr').value.trim();
  const color = document.getElementById('ci_color').value;
  if (!id) return alert("ID intervenante requis.");

  // si pas de coords issues du bouton "Géocoder", on tente la BAN
  if (ci_lat==null || ci_lon==null) {
    const hits = await geocodeBAN(addr);
    if (hits[0]) { ci_lat=hits[0].lat; ci_lon=hits[0].lon; }
  }

  const payload = { id_intervenante:id, nom, adresse_intervenante:addr, lat:ci_lat, lon:ci_lon, color };

  // 1) Tenter INSERT
  let ins = await supabase.from('api.intervenantes_rw').insert([payload]).select();
  if (ins.error) {
    // 2) Si doublon (clé existante) => faire UPDATE
    // (code Postgres usuels pour doublon: 23505 ; selon PostgREST, error.code peut être absent, on teste aussi le message)
    const isDup = ins.error.code === '23505' || /duplicate key|already exists/i.test(ins.error.message || '');
    if (!isDup) { alert(ins.error.message); return; }

    const upd = await supabase.from('api.intervenantes_rw').update(payload).eq('id_intervenante', id).select();
    if (upd.error) { alert(upd.error.message); return; }
  }

  ci_lat = ci_lon = null;
  alert('Intervenante enregistrée.');
  await loadData();
};

document.getElementById('ci_link').onclick = async ()=>{
  if (!canEdit()) return alert('Non autorisé.');
  const id = document.getElementById('ci_id').value.trim();
  const b  = document.getElementById('ci_benef_select').value;
  if (!id || !b) return;
  await supabase.from('api.lien_rw').delete().eq('id_beneficiaire', b).eq('id_intervenante', id);
  const ins = await supabase.from('api.lien_rw').insert([{ id_beneficiaire:b, id_intervenante:id, is_primary:true }]);
  if (ins.error) { alert(ins.error.message); return; }
  alert('Lien créé (primaire).'); await loadData();
};
document.getElementById('cb_create_and_link').onclick = async ()=>{
  if (!canEdit()) return alert('Non autorisé.');
  const idI = document.getElementById('ci_id').value.trim();
  const idB = document.getElementById('cb_id_inline').value.trim();
  const nomB= document.getElementById('cb_nom_inline').value.trim();
  const addr= document.getElementById('cb_addr_inline').value.trim();
  if (!idI || !idB) return alert('ID intervenante + ID bénéficiaire requis.');
  const hits = await geocodeBAN(addr);
  const lat = hits[0]?.lat ?? null, lon = hits[0]?.lon ?? null;
  const insB = await supabase.from('api.beneficiaires_rw').insert([{ id_beneficiaire:idB, nom:nomB, adresse_beneficiaire:addr, lat, lon }]).select();
  if (insB.error) { alert(insB.error.message); return; }
  await supabase.from('api.lien_rw').insert([{ id_beneficiaire:idB, id_intervenante:idI, is_primary:true }]);
  alert('Bénéficiaire créé & lié.'); await loadData();
};

/*** ====== CRUD Bénéficiaire ====== ***/
let cb_lat=null, cb_lon=null;
document.getElementById('cb_geocode').onclick = async ()=>{
  const addr = document.getElementById('cb_addr').value.trim();
  const hits = await geocodeBAN(addr);
  if (!hits[0]) return alert('Adresse introuvable.');
  cb_lat = hits[0].lat; cb_lon = hits[0].lon;
  map.setView([cb_lat, cb_lon], 16);
};
document.getElementById('cb_save').onclick = async ()=>{
  if (!canEdit()) return alert('Non autorisé.');
  const idB = document.getElementById('cb_id').value.trim();
  const nom = document.getElementById('cb_nom').value.trim();
  const addr= document.getElementById('cb_addr').value.trim();
  const idI = document.getElementById('cb_interv_select').value;
  if (!idB) return alert('ID bénéficiaire requis.');
  if (cb_lat==null || cb_lon==null){
    const hits = await geocodeBAN(addr);
    if (hits[0]) { cb_lat=hits[0].lat; cb_lon=hits[0].lon; }
  }
  const ins = await supabase.from('api.beneficiaires_rw').insert([{ id_beneficiaire:idB, nom, adresse_beneficiaire:addr, lat:cb_lat, lon:cb_lon }]).select();
  if (ins.error) { alert(ins.error.message); return; }
  if (idI) await supabase.from('api.lien_rw').insert([{ id_beneficiaire:idB, id_intervenante:idI, is_primary:true }]);
  cb_lat=cb_lon=null; alert('Bénéficiaire créé.'); await loadData();
};

/*** ====== Liens n-n ====== ***/
document.getElementById('ln_benef').onchange = ()=>{
  const bId = document.getElementById('ln_benef').value;
  const box = document.getElementById('ln_interv_list'); box.innerHTML='';
  if (!bId) return;
  const b = cacheBenef.find(x=>x.id_beneficiaire===bId);
  const current = new Set(b?.intervenantes||[]);
  const primary = b?.primary_intervenante || null;
  cacheInterv.forEach(i=>{
    const id=i.id_intervenante;
    const chk = document.createElement('input'); chk.type='checkbox'; chk.value=id; chk.checked=current.has(id);
    const radio = document.createElement('input'); radio.type='radio'; radio.name='ln_primary'; radio.value=id; radio.checked = (primary===id);
    const label = document.createElement('label'); label.className='pill'; label.style.border = '1px solid #ddd';
    label.appendChild(chk); label.append(` ${id} `); label.appendChild(radio); label.append(' primaire');
    box.appendChild(label);
  });
};
document.getElementById('ln_save').onclick = async ()=>{
  if (!canEdit()) return alert('Non autorisé.');
  const bId = document.getElementById('ln_benef').value; if (!bId) return;
  const checks = Array.from(document.querySelectorAll('#ln_interv_list input[type=checkbox]'));
  const selected = checks.filter(c=>c.checked).map(c=>c.value);
  const primary = (document.querySelector('#ln_interv_list input[name=ln_primary]:checked')||{}).value || null;
  await supabase.from('api.lien_rw').delete().eq('id_beneficiaire', bId);
  if (selected.length){
    const rows = selected.map((id,i)=>({ id_beneficiaire:bId, id_intervenante:id, is_primary: (primary? id===primary : i===0) }));
    const ins = await supabase.from('api.lien_rw').insert(rows);
    if (ins.error) { alert(ins.error.message); return; }
  }
  await loadData();
};

/*** ====== AUTH ====== ***/
document.getElementById('btnLogin').onclick = async ()=>{
  const email = (document.getElementById('email').value||'').trim().toLowerCase();
  const password = document.getElementById('password').value;
  if (!email || !password) return alert('Entrez email et mot de passe.');
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) { alert(error.message); return; }
  // feedback immédiat
  session = data?.session || (await supabase.auth.getSession()).data.session || null;
  setAuthText();
  refreshAuthUI();
  // on laisse onAuthStateChange charger les données
};
document.getElementById('btnLogout').onclick = async ()=>{
  const { error } = await supabase.auth.signOut();
  if (error) { alert(error.message); return; }
  // remise à zéro UI locale (sans attendre l’événement)
  session = null;
  setAuthText();       // "Utilisateur non connecté — connectez-vous"
  clearLayers();       // vide la carte pour être cohérent
  refreshAuthUI();     // masque le panneau de droite
};



/*** ====== BOOTSTRAP ====== ***/
(async ()=>{
  const { data: { session: s } } = await supabase.auth.getSession();
  session = s?.user ? s : null;
  setAuthText();
  refreshAuthUI();        // montrer/cacher tout de suite
  if (session) await loadData();
})();

</script>
</body>
</html>
